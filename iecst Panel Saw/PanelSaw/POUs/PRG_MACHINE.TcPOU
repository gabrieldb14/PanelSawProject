PROGRAM PRG_MACHINE
VAR	
    nInternState : INT := 0;
	
    // Function blocks for automation
    fbPressureBeam : FB_PressureBeam;
    fbPusherClamp : FB_PusherClamp;
    
    // Legacy timers (keeping for compatibility)
    fbPressureBeamTimer : TON;
    fbClampTimer : TON;
    fbSawCut : FB_SawCut; 
    tPressureBeamDelay : TIME := T#500MS;
    tClampDelay : TIME := T#500MS;
	
    nStateBeforeStop : INT := 0;
    nStateBeforeEmergency : INT := 0;
    rCurrentSetPoint : REAL;
    rCurrentCutPoint : REAL;
    nCurrentIndex : INT;
    
    // Automation control variables
    bAutoPressureBeamLower : BOOL;
    bAutoPressureBeamRaise : BOOL;
    bAutoClamp : BOOL;
    bAutoUnclamp : BOOL;
END_VAR

// ===== CALL FUNCTION BLOCKS FOR AUTOMATIC CONTROL =====
fbPressureBeam(
    bEnable := TRUE,
    bLowerCommand := bAutoPressureBeamLower OR GVL_HMI.bPressureBeamCommand,
    bRaiseCommand := bAutoPressureBeamRaise OR (NOT GVL_HMI.bPressureBeamCommand)
);

fbPusherClamp(
    bEnable := TRUE,
    bClampCommand := bAutoClamp OR GVL_HMI.bPusherClampCommand,
    bUnclampCommand := bAutoUnclamp OR (NOT GVL_HMI.bPusherClampCommand),
    rTargetPosition := GVL_HMI.rPusherTargetPosition,
    rCurrentPosition := GVL_HMI.rPusherFencePosition
);

// Update HMI variables from function blocks
GVL_HMI.bPressureBeamActive := fbPressureBeam.bActive;
GVL_HMI.bPressureBeamLowered := fbPressureBeam.bLowered;
GVL_HMI.bPressureBeamRaised := fbPressureBeam.bRaised;
GVL_HMI.bPressureBeamMoving := fbPressureBeam.bMoving;

GVL_HMI.bPusherClampActive := fbPusherClamp.bActive;
GVL_HMI.bPusherClampClamped := fbPusherClamp.bClamped;
GVL_HMI.bPusherClampMoving := fbPusherClamp.bMoving;

// ===== LEGACY TIMER LOGIC (for manual control backward compatibility) =====
fbClampTimer(IN := GVL_HMI.bPusherClampCommand, PT := tClampDelay);
fbPressureBeamTimer(IN := GVL_HMI.bPressureBeamCommand, PT := tPressureBeamDelay);

GVL_HMI.nMachineState := nInternState;
GVL_HMI.nCurrentCutIndex := nCurrentIndex;

// ===== EMERGENCY STOP LOGIC =====
IF GVL_HMI.bEmergencyButton AND nInternState <> 999 THEN
    nStateBeforeEmergency := nInternState;
    nInternState := 999;
    GVL_HMI.bScoringSawActive := FALSE;
    GVL_HMI.bMainSawActive := FALSE;
    bAutoPressureBeamRaise := TRUE;
    bAutoPressureBeamLower := FALSE;
    bAutoUnclamp := TRUE;
    bAutoClamp := FALSE;
    fbSawCut(bExecute := FALSE, bResetTimer := TRUE);
END_IF

IF GVL_HMI.bEmergencyResetButton THEN
    GVL_HMI.bEmergencyButton := FALSE;
    nInternState := 0;
    GVL_HMI.bEmergencyResetButton := FALSE;
END_IF

// ===== STOP CYCLE LOGIC =====
IF GVL_HMI.bStopCycle THEN
    nStateBeforeStop := nInternState;
    nInternState := 4;
    fbSawCut(bExecute := FALSE);
    GVL_HMI.bScoringSawActive := FALSE;
    GVL_HMI.bMainSawActive := FALSE;
END_IF

// ===== SAFETY FENCE CHECK =====
IF NOT GVL_HMI.bSafetyFencesClosed AND (nInternState = 1 OR nInternState = 2) THEN
    nInternState := 999;
    GVL_HMI.sStateDescription := 'EMERGENCY: Safety fence opened during operation!';
END_IF

// ===== MAIN STATE MACHINE =====
CASE nInternState OF
	
    0: // Machine Idling
        GVL_HMI.sStateDescription := 'Machine Idling.';
        GVL_HMI.bMainSawActive := FALSE;
        GVL_HMI.bScoringSawActive := FALSE;
        fbSawCut(bExecute := FALSE);
        
        // Reset automation flags
        bAutoPressureBeamLower := FALSE;
        bAutoPressureBeamRaise := TRUE;
        bAutoUnclamp := TRUE;
        bAutoClamp := FALSE;
        
        nCurrentIndex := 0;
        rCurrentSetPoint := 0.0;
        
        IF GVL_HMI.bStartCycle THEN
            GVL_HMI.bStartCycle := FALSE;
            IF GVL_HMI.nTotalCut > 0 AND GVL_HMI.nTotalCut <= 20 THEN
                IF NOT GVL_HMI.bSafetyFencesClosed THEN
                    GVL_HMI.sStateDescription := 'ERROR: Safety Fences not closed.';
                ELSE
                    nCurrentIndex := 1;
                    nInternState := 1;
                END_IF
            END_IF
        END_IF
	
    1: // Positioning
        GVL_HMI.sStateDescription := 'Positioning pusher...';
        fbSawCut(bExecute := FALSE);
        
        IF GVL_HMI.nTotalCut < 1 OR GVL_HMI.nTotalCut > 20 THEN
            GVL_HMI.sStateDescription := 'ERROR: Cut Index out of range';
            nInternState := 999;
        END_IF
        
        rCurrentSetPoint := GVL_HMI.arCutList[nCurrentIndex];
        rCurrentCutPoint := rCurrentSetPoint + GVL_Parameters.stMainBlade.rBladeThickness / 2;
        GVL_HMI.rPusherTargetPosition := rCurrentCutPoint;
        
        // Move pusher to position
        IF ABS(GVL_HMI.rPusherFencePosition - rCurrentCutPoint) > 0.1 THEN
            // Raise beam while moving
            bAutoPressureBeamRaise := TRUE;
            bAutoPressureBeamLower := FALSE;
            bAutoUnclamp := TRUE;
            
            IF GVL_HMI.rPusherFencePosition < rCurrentCutPoint THEN
                GVL_HMI.rPusherFencePosition := GVL_HMI.rPusherFencePosition + 0.1;
            ELSIF GVL_HMI.rPusherFencePosition > rCurrentCutPoint THEN
                GVL_HMI.rPusherFencePosition := GVL_HMI.rPusherFencePosition - 0.1;				
            END_IF
        ELSE
            // At position - lower beam and clamp
            GVL_HMI.sStateDescription := 'Lowering pressure beam and clamping...';
            bAutoPressureBeamLower := TRUE;
            bAutoPressureBeamRaise := FALSE;
            bAutoClamp := TRUE;
            bAutoUnclamp := FALSE;
            
            // Wait for beam to lower and clamp to engage before cutting
            IF fbPressureBeam.bLowered AND fbPusherClamp.bClamped THEN
                nInternState := 2;
            END_IF
        END_IF
        
    2: // Cutting
        GVL_HMI.sStateDescription := CONCAT('Cutting ', INT_TO_STRING(nCurrentIndex));
        
        // Call FB_SawCut with correct parameters
        fbSawCut(
            bExecute := TRUE,
            rPanelWidth := GVL_Parameters.stPanelData.rPanelWidth,
            bResetTimer := FALSE
        );
        
        // Activate saws when cutting is busy
        IF fbSawCut.bBusy THEN
            GVL_HMI.bScoringSawActive := TRUE;
            GVL_HMI.bMainSawActive := TRUE;
        END_IF
        
        // Handle errors
        IF fbSawCut.bError THEN
            GVL_HMI.sStateDescription := 'Error during cutting operation';
            GVL_HMI.bScoringSawActive := FALSE;
            GVL_HMI.bMainSawActive := FALSE;
            nInternState := 999;
            
        // Handle completion
        ELSIF fbSawCut.bDone THEN
            GVL_HMI.bScoringSawActive := FALSE;
            GVL_HMI.bMainSawActive := FALSE;
            fbSawCut(bExecute := FALSE);
            
            // Raise beam and unclamp after cut
            bAutoPressureBeamRaise := TRUE;
            bAutoPressureBeamLower := FALSE;
            bAutoUnclamp := TRUE;
            bAutoClamp := FALSE;
            
            rCurrentCutPoint := 0.0;
            nCurrentIndex := nCurrentIndex + 1;
            
            // Wait for beam to raise and unclamp before next cut
            IF fbPressureBeam.bRaised AND fbPusherClamp.bUnclamped THEN
                IF nCurrentIndex > GVL_HMI.nTotalCut THEN
                    nInternState := 3;
                ELSE
                    nInternState := 1;
                END_IF
            END_IF
        END_IF
	
    3: // Returning to home
        GVL_HMI.sStateDescription := 'Returning to home position...';
        GVL_HMI.bScoringSawActive := FALSE;
        GVL_HMI.bMainSawActive := FALSE;
        fbSawCut(bExecute := FALSE);
        
        bAutoPressureBeamRaise := TRUE;
        bAutoPressureBeamLower := FALSE;
        bAutoUnclamp := TRUE;
        bAutoClamp := FALSE;
        
        IF GVL_HMI.rPusherFencePosition > 0.0 THEN
            GVL_HMI.rPusherFencePosition := GVL_HMI.rPusherFencePosition - 0.1;
        ELSE
            GVL_HMI.rPusherFencePosition := 0.0;
            GVL_HMI.sStateDescription := 'Cycle complete!';
            nInternState := 0;
        END_IF
		
    4: // Machine stopped
        GVL_HMI.sStateDescription := 'Machine stopped.';
        GVL_HMI.bScoringSawActive := FALSE;
        GVL_HMI.bMainSawActive := FALSE;
        fbSawCut(bExecute := FALSE);
        
        bAutoPressureBeamRaise := TRUE;
        bAutoPressureBeamLower := FALSE;
        bAutoUnclamp := TRUE;
        bAutoClamp := FALSE;
        
        IF NOT GVL_HMI.bStopCycle THEN
            nInternState := nStateBeforeStop;
        END_IF
	
    999: // EMERGENCY STATE
        GVL_HMI.sStateDescription := '***EMERGENCY STOP***';
        GVL_HMI.bScoringSawActive := FALSE;
        GVL_HMI.bMainSawActive := FALSE;
        fbSawCut(bExecute := FALSE, bResetTimer := TRUE);
        
        bAutoPressureBeamRaise := TRUE;
        bAutoPressureBeamLower := FALSE;
        bAutoUnclamp := TRUE;
        bAutoClamp := FALSE;
		
END_CASE